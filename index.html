<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英語辞書アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .clickable-word { 
            cursor: pointer; 
            color: blue; 
            text-decoration: underline;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .clickable-word:hover { 
            background-color: yellow; 
        }
        #dictionary-popup {
            z-index: 9999;
        }
        .dictionary-content {
            font-size: 16px;
            line-height: 1.4;
        }
        .pronunciation span {
            font-size: 20px;
        }
        .pos-header {
            margin-top: 16px;
            margin-bottom: 8px;
        }
        .definition {
            margin-bottom: 12px;
        }
        .example {
            margin-left: 28px;
            margin-bottom: 6px;
            padding: 8px;
        }
        .translation {
            margin-left: 28px;
            margin-bottom: 8px;
        }
        .info-item {
            margin-bottom: 8px;
            padding: 8px;
        }
        .target-word {
            font-weight: bold;
            color: #1d4ed8;
        }
        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .debug-info {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="max-w-4xl mx-auto p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">
            <i class="fas fa-book mr-2"></i>
            英語辞書アプリ（デバッグ版）
        </h1>

        <!-- デバッグ情報表示エリア -->
        <div id="debug-section" class="mb-6">
            <div class="debug-info">
                <div><strong>デバッグ情報:</strong></div>
                <div id="debug-log">アプリを初期化中...</div>
            </div>
        </div>

        <!-- タブメニュー -->
        <div class="flex border-b mb-6">
            <button id="file-tab" class="px-4 py-2 border-b-2 border-blue-500 text-blue-600 bg-blue-50 font-medium">
                <i class="fas fa-upload mr-2"></i>ファイル
            </button>
            <button id="text-tab" class="px-4 py-2 border-b-2 border-transparent text-gray-500 font-medium">
                <i class="fas fa-edit mr-2"></i>テキスト
            </button>
        </div>

        <!-- ファイル入力エリア -->
        <div id="file-input-area" class="mb-6">
            <!-- スマホ用ボタン -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <button id="camera-btn" class="bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-lg transition-colors font-medium flex items-center justify-center space-x-2">
                    <i class="fas fa-camera text-xl"></i>
                    <span>カメラで撮影</span>
                </button>
                <button id="gallery-btn" class="bg-green-500 hover:bg-green-600 text-white p-4 rounded-lg transition-colors font-medium flex items-center justify-center space-x-2">
                    <i class="fas fa-images text-xl"></i>
                    <span>写真を選択</span>
                </button>
            </div>
            
            <!-- PC用ドラッグ&ドロップエリア -->
            <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors">
                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-3"></i>
                <p class="text-base text-gray-600 mb-2">ファイルをドロップするかクリック</p>
                <p class="text-sm text-gray-500">対応形式: PNG, JPG, JPEG</p>
            </div>
            
            <!-- 画像プレビューエリア -->
            <div id="image-preview-area" class="mt-4 hidden">
                <div class="bg-white rounded-lg shadow p-4">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">選択された画像:</h3>
                    <img id="image-preview" class="image-preview mx-auto" />
                    <div class="mt-3 flex gap-3">
                        <button id="process-image-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md transition-colors font-medium">
                            <i class="fas fa-text-width mr-2"></i>文字を抽出
                        </button>
                        <button id="cancel-image-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md transition-colors font-medium">
                            <i class="fas fa-times mr-2"></i>キャンセル
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 隠された入力要素 -->
            <input type="file" id="file-input" class="hidden" accept="image/*">
            <input type="file" id="camera-input" class="hidden" accept="image/*" capture="environment">
            <input type="file" id="gallery-input" class="hidden" accept="image/*">
        </div>

        <!-- テキスト入力エリア -->
        <div id="text-input-area" class="mb-6 hidden">
            <div class="bg-white rounded-lg shadow p-6">
                <label for="text-area" class="block text-lg font-medium text-gray-700 mb-3">
                    <i class="fas fa-keyboard mr-2"></i>英語テキストを貼り付けてください
                </label>
                <textarea 
                    id="text-area" 
                    class="w-full h-40 p-3 border border-gray-300 rounded-md resize-vertical focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="ここに英語テキストを貼り付けるか、直接入力してください...

例：
Artificial Intelligence (AI) has become one of the most transformative technologies of our time."
                ></textarea>
                <div class="flex gap-3 mt-4">
                    <button id="process-text-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md transition-colors font-medium">
                        <i class="fas fa-play mr-2"></i>テキストを処理
                    </button>
                    <button id="clear-text-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md transition-colors font-medium">
                        <i class="fas fa-trash mr-2"></i>クリア
                    </button>
                    <button id="sample-text-btn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-md transition-colors font-medium">
                        <i class="fas fa-file-alt mr-2"></i>サンプルテキスト
                    </button>
                </div>
            </div>
        </div>

        <!-- プログレスセクション -->
        <div id="progress-section" class="mb-6 hidden">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center mb-3">
                    <i class="fas fa-cog fa-spin text-blue-500 mr-3"></i>
                    <span id="progress-text" class="text-lg font-medium">処理中...</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="progress-bar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div id="progress-detail" class="text-sm text-gray-600 mt-2"></div>
            </div>
        </div>

        <!-- テキスト表示セクション -->
        <div id="text-section" class="hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold text-gray-800">
                            <i class="fas fa-file-text mr-2"></i>抽出されたテキスト
                        </h2>
                        <button id="copy-text-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition-colors text-sm font-medium">
                            <i class="fas fa-copy mr-2"></i>テキストをコピー
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div id="extracted-text" class="text-gray-700 leading-relaxed whitespace-pre-wrap"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 辞書ポップアップ -->
    <div id="dictionary-popup" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 id="popup-word" class="text-3xl font-bold text-gray-800"></h3>
                <button id="close-popup" class="text-gray-500 hover:text-gray-700 text-3xl font-bold">&times;</button>
            </div>
            <div id="popup-content" class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                <!-- 辞書内容がここに表示される -->
            </div>
        </div>
    </div>

    <script>
        // Gemini API Key
        const GEMINI_API_KEY = 'AIzaSyDmc8isiXiQf9fZaO71l42Fte_2NPZXLG8';
        
        // デバッグ関数
        function debugLog(message) {
            const debugElement = document.getElementById('debug-log');
            if (debugElement) {
                const timestamp = new Date().toLocaleTimeString();
                debugElement.innerHTML += `<br>[${timestamp}] ${message}`;
            }
            console.log(`[DEBUG] ${message}`);
        }
        
        // 辞書アプリのメイン機能
        class DictionaryApp {
            constructor() {
                this.currentText = '';
                this.currentWord = '';
                this.currentImageFile = null;
                this.initializeElements();
                this.setupEventListeners();
                this.checkTesseractJS();
            }
            
            checkTesseractJS() {
                debugLog('Tesseract.js チェック開始');
                
                if (typeof Tesseract === 'undefined') {
                    debugLog('❌ Tesseract.js が見つかりません');
                    return;
                }
                
                debugLog('✅ Tesseract.js が見つかりました');
                debugLog(`Tesseract version: ${Tesseract.version || 'unknown'}`);
                
                // 簡単なテストを実行
                this.testTesseract();
            }
            
            async testTesseract() {
                try {
                    debugLog('Tesseract.js テスト実行中...');
                    
                    // 小さなテスト画像を作成
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 200;
                    canvas.height = 50;
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, 200, 50);
                    ctx.fillStyle = 'black';
                    ctx.font = '20px Arial';
                    ctx.fillText('Hello World', 10, 30);
                    
                    debugLog('テスト画像を作成しました');
                    
                    const result = await Tesseract.recognize(canvas, 'eng');
                    debugLog(`テスト結果: "${result.data.text.trim()}"`);
                    debugLog('✅ Tesseract.js は正常に動作しています');
                    
                } catch (error) {
                    debugLog(`❌ Tesseract.js テスト失敗: ${error.message}`);
                }
            }
            
            initializeElements() {
                this.uploadArea = document.getElementById('upload-area');
                this.fileInput = document.getElementById('file-input');
                this.cameraBtn = document.getElementById('camera-btn');
                this.galleryBtn = document.getElementById('gallery-btn');
                this.cameraInput = document.getElementById('camera-input');
                this.galleryInput = document.getElementById('gallery-input');
                this.imagePreviewArea = document.getElementById('image-preview-area');
                this.imagePreview = document.getElementById('image-preview');
                this.processImageBtn = document.getElementById('process-image-btn');
                this.cancelImageBtn = document.getElementById('cancel-image-btn');
                this.fileTab = document.getElementById('file-tab');
                this.textTab = document.getElementById('text-tab');
                this.fileInputArea = document.getElementById('file-input-area');
                this.textInputArea = document.getElementById('text-input-area');
                this.textArea = document.getElementById('text-area');
                this.processTextBtn = document.getElementById('process-text-btn');
                this.clearTextBtn = document.getElementById('clear-text-btn');
                this.sampleTextBtn = document.getElementById('sample-text-btn');
                this.progressSection = document.getElementById('progress-section');
                this.progressBar = document.getElementById('progress-bar');
                this.progressText = document.getElementById('progress-text');
                this.progressDetail = document.getElementById('progress-detail');
                this.textSection = document.getElementById('text-section');
                this.extractedText = document.getElementById('extracted-text');
                this.copyTextBtn = document.getElementById('copy-text-btn');
                this.dictionaryPopup = document.getElementById('dictionary-popup');
                this.popupWord = document.getElementById('popup-word');
                this.popupContent = document.getElementById('popup-content');
                this.closePopup = document.getElementById('close-popup');
                
                debugLog('要素の初期化完了');
            }

            setupEventListeners() {
                debugLog('イベントリスナー設定開始');
                
                // タブ切り替え
                if (this.fileTab) this.fileTab.addEventListener('click', () => this.switchToFileMode());
                if (this.textTab) this.textTab.addEventListener('click', () => this.switchToTextMode());
                
                // スマホ用ファイル入力
                if (this.cameraBtn) {
                    this.cameraBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        debugLog('カメラボタンがクリックされました');
                        this.openCamera();
                    });
                }
                if (this.galleryBtn) {
                    this.galleryBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        debugLog('ギャラリーボタンがクリックされました');
                        this.openGallery();
                    });
                }
                if (this.cameraInput) {
                    this.cameraInput.addEventListener('change', (e) => {
                        debugLog('カメラ入力が変更されました');
                        this.handleFileSelect(e);
                    });
                }
                if (this.galleryInput) {
                    this.galleryInput.addEventListener('change', (e) => {
                        debugLog('ギャラリー入力が変更されました');
                        this.handleFileSelect(e);
                    });
                }
                
                // PC用ファイル入力
                if (this.uploadArea) {
                    this.uploadArea.addEventListener('click', () => {
                        debugLog('アップロードエリアがクリックされました');
                        if (this.fileInput) this.fileInput.click();
                    });
                }
                if (this.fileInput) {
                    this.fileInput.addEventListener('change', (e) => {
                        debugLog('ファイル入力が変更されました');
                        this.handleFileSelect(e);
                    });
                }
                
                // 画像処理ボタン
                if (this.processImageBtn) {
                    this.processImageBtn.addEventListener('click', () => {
                        debugLog('画像処理ボタンがクリックされました');
                        this.processImageWithOCR();
                    });
                }
                if (this.cancelImageBtn) {
                    this.cancelImageBtn.addEventListener('click', () => {
                        debugLog('キャンセルボタンがクリックされました');
                        this.cancelImageSelection();
                    });
                }
                
                // テキスト処理
                if (this.processTextBtn) this.processTextBtn.addEventListener('click', () => this.processInputText());
                if (this.clearTextBtn) this.clearTextBtn.addEventListener('click', () => this.clearTextArea());
                if (this.sampleTextBtn) this.sampleTextBtn.addEventListener('click', () => this.loadSampleText());
                
                // ポップアップ
                if (this.closePopup) this.closePopup.addEventListener('click', () => this.closeDictionaryPopup());
                if (this.dictionaryPopup) this.dictionaryPopup.addEventListener('click', (e) => {
                    if (e.target === this.dictionaryPopup) this.closeDictionaryPopup();
                });
                
                // ESCキー
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') this.closeDictionaryPopup();
                });
                
                // 単語クリック
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('clickable-word')) {
                        const word = e.target.getAttribute('data-word');
                        if (word) this.showDictionary(word);
                    }
                });
                
                // コピー機能
                if (this.copyTextBtn) this.copyTextBtn.addEventListener('click', () => this.copyToClipboard());
                
                debugLog('イベントリスナー設定完了');
            }
            
            switchToFileMode() {
                this.fileTab.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
                this.fileTab.classList.remove('border-transparent', 'text-gray-500');
                this.textTab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
                this.textTab.classList.add('border-transparent', 'text-gray-500');
                this.fileInputArea.classList.remove('hidden');
                this.textInputArea.classList.add('hidden');
            }
            
            switchToTextMode() {
                this.textTab.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
                this.textTab.classList.remove('border-transparent', 'text-gray-500');
                this.fileTab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
                this.fileTab.classList.add('border-transparent', 'text-gray-500');
                this.textInputArea.classList.remove('hidden');
                this.fileInputArea.classList.add('hidden');
                setTimeout(() => {
                    if (this.textArea) this.textArea.focus();
                }, 100);
            }
            
            openCamera() {
                try {
                    debugLog('カメラを開こうとしています...');
                    if (this.cameraInput) {
                        this.cameraInput.value = '';
                        this.cameraInput.click();
                        debugLog('カメラ入力をクリックしました');
                    } else {
                        debugLog('❌ カメラ入力要素が見つかりません');
                    }
                } catch (error) {
                    debugLog(`❌ カメラエラー: ${error.message}`);
                }
            }
            
            openGallery() {
                try {
                    debugLog('ギャラリーを開こうとしています...');
                    if (this.galleryInput) {
                        this.galleryInput.value = '';
                        this.galleryInput.click();
                        debugLog('ギャラリー入力をクリックしました');
                    } else {
                        debugLog('❌ ギャラリー入力要素が見つかりません');
                    }
                } catch (error) {
                    debugLog(`❌ ギャラリーエラー: ${error.message}`);
                }
            }
            
            handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) {
                    debugLog('ファイルが選択されていません');
                    return;
                }
                
                debugLog(`ファイル選択: ${file.name}, タイプ: ${file.type}, サイズ: ${file.size} bytes`);
                
                if (!file.type.startsWith('image/')) {
                    debugLog('❌ 画像ファイルではありません');
                    alert('画像ファイル（PNG, JPG, JPEG）を選択してください。');
                    return;
                }
                
                this.currentImageFile = file;
                this.showImagePreview(file);
            }
            
            showImagePreview(file) {
                debugLog('画像プレビューを表示中...');
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (this.imagePreview) {
                        this.imagePreview.src = e.target.result;
                        debugLog('画像プレビューを設定しました');
                    }
                    if (this.imagePreviewArea) {
                        this.imagePreviewArea.classList.remove('hidden');
                        debugLog('画像プレビューエリアを表示しました');
                    }
                };
                reader.onerror = (e) => {
                    debugLog(`❌ ファイル読み込みエラー: ${e.target.error}`);
                };
                reader.readAsDataURL(file);
            }
            
            cancelImageSelection() {
                debugLog('画像選択をキャンセル中...');
                this.currentImageFile = null;
                if (this.imagePreviewArea) {
                    this.imagePreviewArea.classList.add('hidden');
                }
                // 入力フィールドをクリア
                if (this.fileInput) this.fileInput.value = '';
                if (this.cameraInput) this.cameraInput.value = '';
                if (this.galleryInput) this.galleryInput.value = '';
                debugLog('画像選択をキャンセルしました');
            }
            
            async processImageWithOCR() {
                if (!this.currentImageFile) {
                    debugLog('❌ 処理する画像ファイルがありません');
                    alert('画像が選択されていません。');
                    return;
                }
                
                debugLog(`OCR処理開始: ${this.currentImageFile.name}`);
                this.showProgress('OCRで文字を認識中...', 'Tesseract.jsを初期化しています...');
                
                try {
                    if (typeof Tesseract === 'undefined') {
                        throw new Error('Tesseract.js ライブラリが読み込まれていません');
                    }
                    
                    debugLog('Tesseract.recognize を実行中...');
                    
                    const result = await Tesseract.recognize(
                        this.currentImageFile,
                        'eng',
                        {
                            logger: (m) => {
                                debugLog(`OCR ログ: ${m.status} - ${Math.round(m.progress * 100)}%`);
                                if (m.status === 'recognizing text') {
                                    const progress = Math.round(m.progress * 100);
                                    this.updateProgress(progress, 'OCRで文字を認識中...', `処理進捗: ${progress}%`);
                                } else if (m.status) {
                                    this.updateProgress(50, 'OCRで文字を認識中...', `ステータス: ${m.status}`);
                                }
                            }
                        }
                    );
                    
                    debugLog(`OCR完了 - 信頼度: ${result.data.confidence}%`);
                    debugLog(`認識テキスト長: ${result.data.text.length} 文字`);
                    debugLog(`認識テキスト: "${result.data.text}"`);
                    
                    const extractedText = result.data.text.trim();
                    
                    if (extractedText && extractedText.length > 0) {
                        debugLog('✅ テキスト抽出成功');
                        this.updateProgress(100, '文字認識完了！', `信頼度: ${Math.round(result.data.confidence)}%`);
                        setTimeout(() => {
                            this.displayExtractedText(extractedText);
                            this.cancelImageSelection();
                        }, 1000);
                    } else {
                        debugLog('❌ 空のテキストが返されました');
                        alert('画像から文字を認識できませんでした。\n\n以下を確認してください：\n- 画像が鮮明か\n- 文字が読みやすいか\n- 英語の文字が含まれているか');
                        this.hideProgress();
                    }
                    
                } catch (error) {
                    debugLog(`❌ OCR処理エラー: ${error.message}`);
                    debugLog(`エラースタック: ${error.stack}`);
                    alert(`OCR処理に失敗しました：\n${error.message}\n\nブラウザの開発者ツールで詳細を確認してください。`);
                    this.hideProgress();
                }
            }
            
            processInputText() {
                const inputText = this.textArea.value.trim();
                if (!inputText) {
                    alert('テキストを入力してください。');
                    return;
                }
                this.showProgress('テキストを処理中...', '');
                setTimeout(() => {
                    this.displayExtractedText(inputText);
                }, 500);
            }
            
            clearTextArea() {
                if (this.textArea) {
                    this.textArea.value = '';
                    this.textArea.focus();
                }
                if (this.textSection) this.textSection.classList.add('hidden');
                this.currentText = '';
            }
            
            loadSampleText() {
                const sampleText = "Artificial Intelligence (AI) has become one of the most transformative technologies of our time. Machine learning algorithms can analyze vast amounts of data to identify patterns and make predictions. Natural language processing enables computers to understand and generate human language.\n\nThe applications of AI are diverse and growing rapidly. In healthcare, AI helps doctors diagnose diseases more accurately. In transportation, autonomous vehicles use AI to navigate safely. However, the development of AI also raises important ethical questions about privacy, bias, and transparency.";

                if (this.textArea) {
                    this.textArea.value = sampleText;
                    if (confirm('サンプルテキストを読み込みました。すぐに処理を開始しますか？')) {
                        this.processInputText();
                    }
                }
            }
            
            displayExtractedText(text) {
                this.currentText = text;
                const processedText = this.makeWordsClickable(text);
                if (this.extractedText) {
                    this.extractedText.innerHTML = processedText;
                }
                if (this.textSection) this.textSection.classList.remove('hidden');
                this.updateProgress(100, '完了！', '');
                setTimeout(() => this.hideProgress(), 1000);
            }
            
            makeWordsClickable(text) {
                const wordPattern = /\b[a-zA-Z]{2,}\b/g;
                return text.replace(wordPattern, (word) => {
                    return `<span class="clickable-word" data-word="${word.toLowerCase()}">${word}</span>`;
                });
            }
            
            async showDictionary(word) {
                if (!this.dictionaryPopup || !this.popupWord || !this.popupContent) return;
                
                this.currentWord = word;
                this.popupWord.textContent = word;
                this.popupContent.innerHTML = '<div class="flex justify-center p-4"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div></div>';
                this.dictionaryPopup.classList.remove('hidden');
                
                try {
                    const prompt = `英単語「${word}」の辞書情報を以下の形式で出力してください：

発音記号: [IPA発音記号]

【名詞】（該当する場合のみ）
1. 意味1の日本語訳
   例文: English example sentence.
   訳: 日本語訳

【動詞】（該当する場合のみ）
1. 動詞の意味の日本語訳
   例文: Verb example sentence.
   訳: 日本語訳

【形容詞】（該当する場合のみ）
1. 形容詞の意味の日本語訳
   例文: Adjective example sentence.
   訳: 日本語訳

語源: 単語の語源
類義語: synonym1, synonym2
対義語: antonym1, antonym2

辞書らしく簡潔で正確な情報のみを出力してください。`;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: {
                                temperature: 0.7,
                                topK: 40,
                                topP: 0.95,
                                maxOutputTokens: 800
                            }
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
                        this.displayDictionary(data.candidates[0].content.parts[0].text, word);
                    } else {
                        throw new Error('辞書情報を取得できませんでした');
                    }
                } catch (error) {
                    this.popupContent.innerHTML = `
                        <div class="text-red-600 p-4">
                            <p>❌ 辞書情報の取得に失敗しました</p>
                            <p class="text-sm mt-2">${error.message}</p>
                        </div>
                    `;
                }
            }
            
            displayDictionary(dictText, word) {
                const html = `
                    <div class="dictionary-layout">
                        <div class="flex items-center justify-between mb-4 pb-3 border-b-2 border-blue-200">
                            <h3 class="text-3xl font-bold text-gray-800">${word}</h3>
                            <button onclick="window.dictionaryApp.speakWord('${word}')" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-lg font-medium flex items-center space-x-2">
                                <span>🔊</span>
                                <span>音声再生</span>
                            </button>
                        </div>
                        
                        <div class="dictionary-content text-base">
                            ${this.formatDictionary(dictText)}
                        </div>
                        
                        <div class="bg-gray-100 rounded p-2 mt-4 text-sm text-gray-600">
                            🤖 Powered by Gemini AI
                        </div>
                    </div>
                `;
                
                this.popupContent.innerHTML = html;
            }
            
            formatDictionary(text) {
                let formatted = text.replace(
                    /発音記号\s*[:：]?\s*\[([^\]]+)\]/g, 
                    '<div class="pronunciation mb-3 text-center"><span class="text-xl font-mono text-blue-600 bg-blue-50 px-3 py-2 rounded">/$1/</span></div>'
                );
                
                formatted = formatted.replace(
                    /【([^】]+)】/g, 
                    '<div class="pos-header"><span class="inline-block bg-blue-600 text-white px-3 py-2 rounded font-medium text-lg">$1</span></div>'
                );
                
                formatted = formatted.replace(
                    /^(\d+)\.\s*(.+)$/gm, 
                    '<div class="definition flex"><div class="definition-number mr-3"><span class="inline-flex items-center justify-center w-8 h-8 bg-blue-100 text-blue-600 rounded-full text-lg font-semibold">$1</span></div><div class="definition-content flex-1"><div class="meaning"><span class="text-gray-900 font-medium text-lg">$2</span></div></div></div>'
                );
                
                formatted = formatted.replace(
                    /例文:\s*(.+)/g,
                    (match, sentence) => {
                        const targetWord = this.currentWord;
                        const regex = new RegExp(`\\b${targetWord}\\b`, 'gi');
                        const highlightedSentence = sentence.replace(regex, `<span class="target-word">${targetWord}</span>`);
                        return `<div class="example bg-gray-50 rounded-md"><div class="text-gray-700 italic text-base">${highlightedSentence}</div></div>`;
                    }
                );
                
                formatted = formatted.replace(
                    /訳:\s*(.+)/g,
                    '<div class="translation"><div class="text-gray-600 text-base"><span class="text-blue-500 text-lg">→</span> $1</div></div>'
                );
                
                formatted = formatted.replace(
                    /(語源|類義語|対義語|コロケーション):\s*(.+)/g,
                    '<div class="info-item bg-gray-50 rounded"><div class="font-medium text-gray-700 text-base mb-1">$1</div><div class="text-gray-600 text-base">$2</div></div>'
                );
                
                formatted = formatted.replace(/\n/g, '<br>');
                
                return formatted;
            }
            
            speakWord(word) {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(word);
                    utterance.lang = 'en-US';
                    utterance.rate = 0.8;
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert('お使いのブラウザは音声合成機能をサポートしていません。');
                }
            }
            
            closeDictionaryPopup() {
                if (this.dictionaryPopup) this.dictionaryPopup.classList.add('hidden');
            }
            
            copyToClipboard() {
                if (!this.currentText) return;
                navigator.clipboard.writeText(this.currentText).then(() => {
                    if (this.copyTextBtn) {
                        const originalText = this.copyTextBtn.textContent;
                        this.copyTextBtn.textContent = '✅ コピーしました！';
                        this.copyTextBtn.classList.add('bg-green-500');
                        this.copyTextBtn.classList.remove('bg-blue-500');
                        setTimeout(() => {
                            this.copyTextBtn.textContent = originalText;
                            this.copyTextBtn.classList.remove('bg-green-500');
                            this.copyTextBtn.classList.add('bg-blue-500');
                        }, 2000);
                    }
                });
            }
            
            showProgress(message, detail = '') {
                if (this.progressSection) this.progressSection.classList.remove('hidden');
                this.updateProgress(0, message, detail);
            }
            
            updateProgress(percent, message, detail = '') {
                if (this.progressBar) this.progressBar.style.width = `${percent}%`;
                if (this.progressText) this.progressText.textContent = message;
                if (this.progressDetail) this.progressDetail.textContent = detail;
            }
            
            hideProgress() {
                if (this.progressSection) this.progressSection.classList.add('hidden');
            }
        }
        
        // アプリケーション初期化
        document.addEventListener('DOMContentLoaded', () => {
            debugLog('DOMContentLoaded イベント発生');
            debugLog('アプリケーションを初期化中...');
            
            const app = new DictionaryApp();
            window.dictionaryApp = app;
            
            if ('speechSynthesis' in window) {
                window.speechSynthesis.getVoices();
                debugLog('音声合成機能が利用可能です');
            } else {
                debugLog('音声合成機能は利用できません');
            }
            
            debugLog('アプリケーション初期化完了');
        });
    </script>
</body>
</html>
