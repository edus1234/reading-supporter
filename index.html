<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±èªè¾æ›¸ã‚¢ãƒ—ãƒª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .clickable-word { 
            cursor: pointer; 
            color: blue; 
            text-decoration: underline;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .clickable-word:hover { 
            background-color: yellow; 
        }
        #dictionary-popup {
            z-index: 9999;
        }
        /* è¾æ›¸è¡¨ç¤ºã®æ”¹å–„ */
        .dictionary-content {
            font-size: 16px;
            line-height: 1.4;
        }
        .pronunciation span {
            font-size: 20px;
        }
        .pos-header {
            margin-top: 16px;
            margin-bottom: 8px;
        }
        .definition {
            margin-bottom: 12px;
        }
        .example {
            margin-left: 28px;
            margin-bottom: 6px;
            padding: 8px;
        }
        .translation {
            margin-left: 28px;
            margin-bottom: 8px;
        }
        .info-item {
            margin-bottom: 8px;
            padding: 8px;
        }
        .target-word {
            font-weight: bold;
            color: #1d4ed8;
        }
        /* ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin: 10px 0;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="max-w-4xl mx-auto p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">
            <i class="fas fa-book mr-2"></i>
            è‹±èªè¾æ›¸ã‚¢ãƒ—ãƒª
        </h1>

        <!-- ã‚¿ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        <div class="flex border-b mb-6">
            <button id="file-tab" class="px-4 py-2 border-b-2 border-blue-500 text-blue-600 bg-blue-50 font-medium">
                <i class="fas fa-upload mr-2"></i>ãƒ•ã‚¡ã‚¤ãƒ«
            </button>
            <button id="text-tab" class="px-4 py-2 border-b-2 border-transparent text-gray-500 font-medium">
                <i class="fas fa-edit mr-2"></i>ãƒ†ã‚­ã‚¹ãƒˆ
            </button>
        </div>

        <!-- ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚¨ãƒªã‚¢ -->
        <div id="file-input-area" class="mb-6">
            <!-- ã‚¹ãƒãƒ›ç”¨ãƒœã‚¿ãƒ³ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <button id="camera-btn" class="bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-lg transition-colors font-medium flex items-center justify-center space-x-2">
                    <i class="fas fa-camera text-xl"></i>
                    <span>ã‚«ãƒ¡ãƒ©ã§æ’®å½±</span>
                </button>
                <button id="gallery-btn" class="bg-green-500 hover:bg-green-600 text-white p-4 rounded-lg transition-colors font-medium flex items-center justify-center space-x-2">
                    <i class="fas fa-images text-xl"></i>
                    <span>å†™çœŸã‚’é¸æŠ</span>
                </button>
            </div>
            
            <!-- PCç”¨ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ -->
            <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors">
                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-3"></i>
                <p class="text-base text-gray-600 mb-2">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã‚¯ãƒªãƒƒã‚¯</p>
                <p class="text-sm text-gray-500">å¯¾å¿œå½¢å¼: PNG, JPG, JPEG</p>
            </div>
            
            <!-- ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
            <div id="image-preview-area" class="mt-4 hidden">
                <div class="bg-white rounded-lg shadow p-4">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">é¸æŠã•ã‚ŒãŸç”»åƒ:</h3>
                    <img id="image-preview" class="image-preview mx-auto" />
                    <div class="mt-3 flex gap-3">
                        <button id="process-image-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md transition-colors font-medium">
                            <i class="fas fa-text-width mr-2"></i>æ–‡å­—ã‚’æŠ½å‡º
                        </button>
                        <button id="cancel-image-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md transition-colors font-medium">
                            <i class="fas fa-times mr-2"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- éš ã•ã‚ŒãŸå…¥åŠ›è¦ç´  -->
            <input type="file" id="file-input" class="hidden" accept="image/*">
            <input type="file" id="camera-input" class="hidden" accept="image/*" capture="environment">
            <input type="file" id="gallery-input" class="hidden" accept="image/*">
        </div>

        <!-- ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ -->
        <div id="text-input-area" class="mb-6 hidden">
            <div class="bg-white rounded-lg shadow p-6">
                <label for="text-area" class="block text-lg font-medium text-gray-700 mb-3">
                    <i class="fas fa-keyboard mr-2"></i>è‹±èªãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
                </label>
                <textarea 
                    id="text-area" 
                    class="w-full h-40 p-3 border border-gray-300 rounded-md resize-vertical focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="ã“ã“ã«è‹±èªãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã‚‹ã‹ã€ç›´æ¥å…¥åŠ›ã—ã¦ãã ã•ã„...

ä¾‹ï¼š
Artificial Intelligence (AI) has become one of the most transformative technologies of our time."
                ></textarea>
                <div class="flex gap-3 mt-4">
                    <button id="process-text-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md transition-colors font-medium">
                        <i class="fas fa-play mr-2"></i>ãƒ†ã‚­ã‚¹ãƒˆã‚’å‡¦ç†
                    </button>
                    <button id="clear-text-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md transition-colors font-medium">
                        <i class="fas fa-trash mr-2"></i>ã‚¯ãƒªã‚¢
                    </button>
                    <button id="sample-text-btn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-md transition-colors font-medium">
                        <i class="fas fa-file-alt mr-2"></i>ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚­ã‚¹ãƒˆ
                    </button>
                </div>
            </div>
        </div>

        <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="progress-section" class="mb-6 hidden">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center mb-3">
                    <i class="fas fa-cog fa-spin text-blue-500 mr-3"></i>
                    <span id="progress-text" class="text-lg font-medium">å‡¦ç†ä¸­...</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="progress-bar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div id="progress-detail" class="text-sm text-gray-600 mt-2"></div>
            </div>
        </div>

        <!-- ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="text-section" class="hidden">
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold text-gray-800">
                            <i class="fas fa-file-text mr-2"></i>æŠ½å‡ºã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ
                        </h2>
                        <button id="copy-text-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition-colors text-sm font-medium">
                            <i class="fas fa-copy mr-2"></i>ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div id="extracted-text" class="text-gray-700 leading-relaxed whitespace-pre-wrap"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¾æ›¸ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div id="dictionary-popup" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 id="popup-word" class="text-3xl font-bold text-gray-800"></h3>
                <button id="close-popup" class="text-gray-500 hover:text-gray-700 text-3xl font-bold">&times;</button>
            </div>
            <div id="popup-content" class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                <!-- è¾æ›¸å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
        </div>
    </div>

    <script>
        // Gemini API Key
        const GEMINI_API_KEY = 'AIzaSyDmc8isiXiQf9fZaO71l42Fte_2NPZXLG8';
        
        // è¾æ›¸ã‚¢ãƒ—ãƒªã®ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½
        class DictionaryApp {
            constructor() {
                this.currentText = '';
                this.currentWord = '';
                this.currentImageFile = null;
                this.initializeElements();
                this.setupEventListeners();
            }
            
            initializeElements() {
                this.uploadArea = document.getElementById('upload-area');
                this.fileInput = document.getElementById('file-input');
                this.cameraBtn = document.getElementById('camera-btn');
                this.galleryBtn = document.getElementById('gallery-btn');
                this.cameraInput = document.getElementById('camera-input');
                this.galleryInput = document.getElementById('gallery-input');
                this.imagePreviewArea = document.getElementById('image-preview-area');
                this.imagePreview = document.getElementById('image-preview');
                this.processImageBtn = document.getElementById('process-image-btn');
                this.cancelImageBtn = document.getElementById('cancel-image-btn');
                this.fileTab = document.getElementById('file-tab');
                this.textTab = document.getElementById('text-tab');
                this.fileInputArea = document.getElementById('file-input-area');
                this.textInputArea = document.getElementById('text-input-area');
                this.textArea = document.getElementById('text-area');
                this.processTextBtn = document.getElementById('process-text-btn');
                this.clearTextBtn = document.getElementById('clear-text-btn');
                this.sampleTextBtn = document.getElementById('sample-text-btn');
                this.progressSection = document.getElementById('progress-section');
                this.progressBar = document.getElementById('progress-bar');
                this.progressText = document.getElementById('progress-text');
                this.progressDetail = document.getElementById('progress-detail');
                this.textSection = document.getElementById('text-section');
                this.extractedText = document.getElementById('extracted-text');
                this.copyTextBtn = document.getElementById('copy-text-btn');
                this.dictionaryPopup = document.getElementById('dictionary-popup');
                this.popupWord = document.getElementById('popup-word');
                this.popupContent = document.getElementById('popup-content');
                this.closePopup = document.getElementById('close-popup');
            }

            setupEventListeners() {
                // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
                if (this.fileTab) this.fileTab.addEventListener('click', () => this.switchToFileMode());
                if (this.textTab) this.textTab.addEventListener('click', () => this.switchToTextMode());
                
                // ã‚¹ãƒãƒ›ç”¨ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›
                if (this.cameraBtn) {
                    this.cameraBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.openCamera();
                    });
                }
                if (this.galleryBtn) {
                    this.galleryBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.openGallery();
                    });
                }
                if (this.cameraInput) {
                    this.cameraInput.addEventListener('change', (e) => this.handleFileSelect(e));
                }
                if (this.galleryInput) {
                    this.galleryInput.addEventListener('change', (e) => this.handleFileSelect(e));
                }
                
                // PCç”¨ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›
                if (this.uploadArea) {
                    this.uploadArea.addEventListener('click', () => {
                        if (this.fileInput) this.fileInput.click();
                    });
                }
                if (this.fileInput) {
                    this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                }
                
                // ç”»åƒå‡¦ç†ãƒœã‚¿ãƒ³
                if (this.processImageBtn) {
                    this.processImageBtn.addEventListener('click', () => this.processImageWithOCR());
                }
                if (this.cancelImageBtn) {
                    this.cancelImageBtn.addEventListener('click', () => this.cancelImageSelection());
                }
                
                // ãƒ†ã‚­ã‚¹ãƒˆå‡¦ç†
                if (this.processTextBtn) this.processTextBtn.addEventListener('click', () => this.processInputText());
                if (this.clearTextBtn) this.clearTextBtn.addEventListener('click', () => this.clearTextArea());
                if (this.sampleTextBtn) this.sampleTextBtn.addEventListener('click', () => this.loadSampleText());
                
                // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
                if (this.closePopup) this.closePopup.addEventListener('click', () => this.closeDictionaryPopup());
                if (this.dictionaryPopup) this.dictionaryPopup.addEventListener('click', (e) => {
                    if (e.target === this.dictionaryPopup) this.closeDictionaryPopup();
                });
                
                // ESCã‚­ãƒ¼
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') this.closeDictionaryPopup();
                });
                
                // å˜èªã‚¯ãƒªãƒƒã‚¯
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('clickable-word')) {
                        const word = e.target.getAttribute('data-word');
                        if (word) this.showDictionary(word);
                    }
                });
                
                // ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
                if (this.copyTextBtn) this.copyTextBtn.addEventListener('click', () => this.copyToClipboard());
            }
            
            switchToFileMode() {
                this.fileTab.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
                this.fileTab.classList.remove('border-transparent', 'text-gray-500');
                this.textTab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
                this.textTab.classList.add('border-transparent', 'text-gray-500');
                this.fileInputArea.classList.remove('hidden');
                this.textInputArea.classList.add('hidden');
            }
            
            switchToTextMode() {
                this.textTab.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
                this.textTab.classList.remove('border-transparent', 'text-gray-500');
                this.fileTab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
                this.fileTab.classList.add('border-transparent', 'text-gray-500');
                this.textInputArea.classList.remove('hidden');
                this.fileInputArea.classList.add('hidden');
                setTimeout(() => {
                    if (this.textArea) this.textArea.focus();
                }, 100);
            }
            
            openCamera() {
                try {
                    console.log('ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ã‚’é–‹ã„ã¦ã„ã¾ã™...');
                    if (this.cameraInput) {
                        this.cameraInput.value = '';
                        this.cameraInput.click();
                    } else {
                        alert('ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                    }
                } catch (error) {
                    console.error('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            }
            
            openGallery() {
                try {
                    console.log('ã‚®ãƒ£ãƒ©ãƒªãƒ¼æ©Ÿèƒ½ã‚’é–‹ã„ã¦ã„ã¾ã™...');
                    if (this.galleryInput) {
                        this.galleryInput.value = '';
                        this.galleryInput.click();
                    } else {
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                    }
                } catch (error) {
                    console.error('ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ©Ÿèƒ½ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            }
            
            handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                console.log('é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:', file.name, file.type);
                
                if (!file.type.startsWith('image/')) {
                    alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆPNG, JPG, JPEGï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                this.currentImageFile = file;
                this.showImagePreview(file);
            }
            
            showImagePreview(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (this.imagePreview) {
                        this.imagePreview.src = e.target.result;
                    }
                    if (this.imagePreviewArea) {
                        this.imagePreviewArea.classList.remove('hidden');
                    }
                };
                reader.readAsDataURL(file);
            }
            
            cancelImageSelection() {
                this.currentImageFile = null;
                if (this.imagePreviewArea) {
                    this.imagePreviewArea.classList.add('hidden');
                }
                // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
                if (this.fileInput) this.fileInput.value = '';
                if (this.cameraInput) this.cameraInput.value = '';
                if (this.galleryInput) this.galleryInput.value = '';
            }
            
            async processImageWithOCR() {
                if (!this.currentImageFile) {
                    alert('ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                    return;
                }
                
                this.showProgress('OCRã§æ–‡å­—ã‚’èªè­˜ä¸­...', 'ç”»åƒã‚’è§£æã—ã¦ã„ã¾ã™...');
                
                try {
                    console.log('OCRå‡¦ç†é–‹å§‹:', this.currentImageFile.name);
                    
                    const result = await Tesseract.recognize(
                        this.currentImageFile,
                        'eng',
                        {
                            logger: m => {
                                console.log('OCRé€²æ—:', m);
                                if (m.status === 'recognizing text') {
                                    const progress = Math.round(m.progress * 100);
                                    this.updateProgress(progress, 'OCRã§æ–‡å­—ã‚’èªè­˜ä¸­...', `å‡¦ç†é€²æ—: ${progress}%`);
                                }
                            }
                        }
                    );
                    
                    console.log('OCRçµæœ:', result.data.text);
                    
                    if (result.data.text.trim()) {
                        this.updateProgress(100, 'æ–‡å­—èªè­˜å®Œäº†ï¼', 'ãƒ†ã‚­ã‚¹ãƒˆã‚’å‡¦ç†ã—ã¦ã„ã¾ã™...');
                        setTimeout(() => {
                            this.displayExtractedText(result.data.text.trim());
                            this.cancelImageSelection();
                        }, 500);
                    } else {
                        alert('ç”»åƒã‹ã‚‰æ–‡å­—ã‚’èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nç”»åƒã®å“è³ªã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                        this.hideProgress();
                    }
                    
                } catch (error) {
                    console.error('OCRã‚¨ãƒ©ãƒ¼:', error);
                    alert('æ–‡å­—èªè­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                    this.hideProgress();
                }
            }
            
            processInputText() {
                const inputText = this.textArea.value.trim();
                if (!inputText) {
                    alert('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                this.showProgress('ãƒ†ã‚­ã‚¹ãƒˆã‚’å‡¦ç†ä¸­...', '');
                setTimeout(() => {
                    this.displayExtractedText(inputText);
                }, 500);
            }
            
            clearTextArea() {
                if (this.textArea) {
                    this.textArea.value = '';
                    this.textArea.focus();
                }
                if (this.textSection) this.textSection.classList.add('hidden');
                this.currentText = '';
            }
            
            loadSampleText() {
                const sampleText = "Artificial Intelligence (AI) has become one of the most transformative technologies of our time. Machine learning algorithms can analyze vast amounts of data to identify patterns and make predictions. Natural language processing enables computers to understand and generate human language.\n\nThe applications of AI are diverse and growing rapidly. In healthcare, AI helps doctors diagnose diseases more accurately. In transportation, autonomous vehicles use AI to navigate safely. However, the development of AI also raises important ethical questions about privacy, bias, and transparency.";

                if (this.textArea) {
                    this.textArea.value = sampleText;
                    if (confirm('ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚ã™ãã«å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ')) {
                        this.processInputText();
                    }
                }
            }
            
            displayExtractedText(text) {
                this.currentText = text;
                const processedText = this.makeWordsClickable(text);
                if (this.extractedText) {
                    this.extractedText.innerHTML = processedText;
                }
                if (this.textSection) this.textSection.classList.remove('hidden');
                this.updateProgress(100, 'å®Œäº†ï¼', '');
                setTimeout(() => this.hideProgress(), 1000);
            }
            
            makeWordsClickable(text) {
                const wordPattern = /\b[a-zA-Z]{2,}\b/g;
                return text.replace(wordPattern, (word) => {
                    return `<span class="clickable-word" data-word="${word.toLowerCase()}">${word}</span>`;
                });
            }
            
            async showDictionary(word) {
                if (!this.dictionaryPopup || !this.popupWord || !this.popupContent) return;
                
                this.currentWord = word;
                this.popupWord.textContent = word;
                this.popupContent.innerHTML = '<div class="flex justify-center p-4"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div></div>';
                this.dictionaryPopup.classList.remove('hidden');
                
                try {
                    const prompt = `è‹±å˜èªã€Œ${word}ã€ã®è¾æ›¸æƒ…å ±ã‚’ä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

ç™ºéŸ³è¨˜å·: [IPAç™ºéŸ³è¨˜å·]

ã€åè©ã€‘ï¼ˆè©²å½“ã™ã‚‹å ´åˆã®ã¿ï¼‰
1. æ„å‘³1ã®æ—¥æœ¬èªè¨³
   ä¾‹æ–‡: English example sentence.
   è¨³: æ—¥æœ¬èªè¨³

ã€å‹•è©ã€‘ï¼ˆè©²å½“ã™ã‚‹å ´åˆã®ã¿ï¼‰
1. å‹•è©ã®æ„å‘³ã®æ—¥æœ¬èªè¨³
   ä¾‹æ–‡: Verb example sentence.
   è¨³: æ—¥æœ¬èªè¨³

ã€å½¢å®¹è©ã€‘ï¼ˆè©²å½“ã™ã‚‹å ´åˆã®ã¿ï¼‰
1. å½¢å®¹è©ã®æ„å‘³ã®æ—¥æœ¬èªè¨³
   ä¾‹æ–‡: Adjective example sentence.
   è¨³: æ—¥æœ¬èªè¨³

èªæº: å˜èªã®èªæº
é¡ç¾©èª: synonym1, synonym2
å¯¾ç¾©èª: antonym1, antonym2

è¾æ›¸ã‚‰ã—ãç°¡æ½”ã§æ­£ç¢ºãªæƒ…å ±ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚`;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: {
                                temperature: 0.7,
                                topK: 40,
                                topP: 0.95,
                                maxOutputTokens: 800
                            }
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
                        this.displayDictionary(data.candidates[0].content.parts[0].text, word);
                    } else {
                        throw new Error('è¾æ›¸æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                    }
                } catch (error) {
                    this.popupContent.innerHTML = `
                        <div class="text-red-600 p-4">
                            <p>âŒ è¾æ›¸æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
                            <p class="text-sm mt-2">${error.message}</p>
                        </div>
                    `;
                }
            }
            
            displayDictionary(dictText, word) {
                const html = `
                    <div class="dictionary-layout">
                        <div class="flex items-center justify-between mb-4 pb-3 border-b-2 border-blue-200">
                            <h3 class="text-3xl font-bold text-gray-800">${word}</h3>
                            <button onclick="window.dictionaryApp.speakWord('${word}')" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-lg font-medium flex items-center space-x-2">
                                <span>ğŸ”Š</span>
                                <span>éŸ³å£°å†ç”Ÿ</span>
                            </button>
                        </div>
                        
                        <div class="dictionary-content text-base">
                            ${this.formatDictionary(dictText)}
                        </div>
                        
                        <div class="bg-gray-100 rounded p-2 mt-4 text-sm text-gray-600">
                            ğŸ¤– Powered by Gemini AI
                        </div>
                    </div>
                `;
                
                this.popupContent.innerHTML = html;
            }
            
            formatDictionary(text) {
                // ç™ºéŸ³è¨˜å·ã®æŠ½å‡º
                let formatted = text.replace(
                    /ç™ºéŸ³è¨˜å·\s*[:ï¼š]?\s*\[([^\]]+)\]/g, 
                    '<div class="pronunciation mb-3 text-center"><span class="text-xl font-mono text-blue-600 bg-blue-50 px-3 py-2 rounded">/$1/</span></div>'
                );
                
                // å“è©ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                formatted = formatted.replace(
                    /ã€([^ã€‘]+)ã€‘/g, 
                    '<div class="pos-header"><span class="inline-block bg-blue-600 text-white px-3 py-2 rounded font-medium text-lg">$1</span></div>'
                );
                
                // å®šç¾©ç•ªå·ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                formatted = formatted.replace(
                    /^(\d+)\.\s*(.+)$/gm, 
                    '<div class="definition flex"><div class="definition-number mr-3"><span class="inline-flex items-center justify-center w-8 h-8 bg-blue-100 text-blue-600 rounded-full text-lg font-semibold">$1</span></div><div class="definition-content flex-1"><div class="meaning"><span class="text-gray-900 font-medium text-lg">$2</span></div></div></div>'
                );
                
                // ä¾‹æ–‡ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆå˜èªã‚’å¤ªå­—ã«ã™ã‚‹ï¼‰
                formatted = formatted.replace(
                    /ä¾‹æ–‡:\s*(.+)/g,
                    (match, sentence) => {
                        const targetWord = this.currentWord;
                        const regex = new RegExp(`\\b${targetWord}\\b`, 'gi');
                        const highlightedSentence = sentence.replace(regex, `<span class="target-word">${targetWord}</span>`);
                        return `<div class="example bg-gray-50 rounded-md"><div class="text-gray-700 italic text-base">${highlightedSentence}</div></div>`;
                    }
                );
                
                // è¨³ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                formatted = formatted.replace(
                    /è¨³:\s*(.+)/g,
                    '<div class="translation"><div class="text-gray-600 text-base"><span class="text-blue-500 text-lg">â†’</span> $1</div></div>'
                );
                
                // ãã®ä»–ã®æƒ…å ±
                formatted = formatted.replace(
                    /(èªæº|é¡ç¾©èª|å¯¾ç¾©èª|ã‚³ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³):\s*(.+)/g,
                    '<div class="info-item bg-gray-50 rounded"><div class="font-medium text-gray-700 text-base mb-1">$1</div><div class="text-gray-600 text-base">$2</div></div>'
                );
                
                // æ”¹è¡Œã‚’HTMLã«å¤‰æ›
                formatted = formatted.replace(/\n/g, '<br>');
                
                return formatted;
            }
            
            speakWord(word) {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(word);
                    utterance.lang = 'en-US';
                    utterance.rate = 0.8;
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°åˆæˆæ©Ÿèƒ½ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚');
                }
            }
            
            closeDictionaryPopup() {
                if (this.dictionaryPopup) this.dictionaryPopup.classList.add('hidden');
            }
            
            copyToClipboard() {
                if (!this.currentText) return;
                navigator.clipboard.writeText(this.currentText).then(() => {
                    if (this.copyTextBtn) {
                        const originalText = this.copyTextBtn.textContent;
                        this.copyTextBtn.textContent = 'âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
                        this.copyTextBtn.classList.add('bg-green-500');
                        this.copyTextBtn.classList.remove('bg-blue-500');
                        setTimeout(() => {
                            this.copyTextBtn.textContent = originalText;
                            this.copyTextBtn.classList.remove('bg-green-500');
                            this.copyTextBtn.classList.add('bg-blue-500');
                        }, 2000);
                    }
                });
            }
            
            showProgress(message, detail = '') {
                if (this.progressSection) this.progressSection.classList.remove('hidden');
                this.updateProgress(0, message, detail);
            }
            
            updateProgress(percent, message, detail = '') {
                if (this.progressBar) this.progressBar.style.width = `${percent}%`;
                if (this.progressText) this.progressText.textContent = message;
                if (this.progressDetail) this.progressDetail.textContent = detail;
            }
            
            hideProgress() {
                if (this.progressSection) this.progressSection.classList.add('hidden');
            }
        }
        
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            const app = new DictionaryApp();
            window.dictionaryApp = app;
            
            if ('speechSynthesis' in window) {
                window.speechSynthesis.getVoices();
            }
        });
    </script>
</body>
</html>
